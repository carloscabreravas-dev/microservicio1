name: Deploy to OpenShift

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ vars.REGISTRY }}
          username: ${{ vars.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ vars.REGISTRY }}/${{ vars.IMAGE_NAMESPACE }}/microservicio
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ vars.REGISTRY }}/${{ vars.IMAGE_NAMESPACE }}/microservicio:buildcache
          cache-to: type=registry,ref=${{ vars.REGISTRY }}/${{ vars.IMAGE_NAMESPACE }}/microservicio:buildcache,mode=max

      - name: Install OpenShift CLI
        run: |
          curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz | tar xz
          sudo mv oc /usr/local/bin/
          oc version --client

      - name: Deploy to OpenShift
        env:
          OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
          OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
          OPENSHIFT_NAMESPACE: ${{ vars.OPENSHIFT_NAMESPACE }}
          IMAGE_NAME: ${{ vars.REGISTRY }}/${{ vars.IMAGE_NAMESPACE }}/microservicio:${{ steps.meta.outputs.version }}
        run: |
          # Login
          oc login --server=$OPENSHIFT_SERVER --token=$OPENSHIFT_TOKEN --insecure-skip-tls-verify=true
          
          # Select project
          oc project $OPENSHIFT_NAMESPACE || oc create namespace $OPENSHIFT_NAMESPACE && oc project $OPENSHIFT_NAMESPACE
          
          # Apply manifests
          oc apply -f openshift-deployment.yaml
          
          # Update image
          oc set image deployment/microservicio microservicio=$IMAGE_NAME --record
          
          # Wait for rollout
          oc rollout status deployment/microservicio --timeout=10m

      - name: Get deployment info
        if: success()
        run: |
          oc get pods -n ${{ vars.OPENSHIFT_NAMESPACE }}
          oc get routes -n ${{ vars.OPENSHIFT_NAMESPACE }}

      - name: Post deployment status
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = context.job.status === 'success' ? '✅' : '❌'
            const message = `${status} Deployment to OpenShift - ${{ github.event.inputs.environment || 'staging' }}`
            core.info(message)
